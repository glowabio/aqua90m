<!--#https://www.geeksforgeeks.org/using-leaflet-js-to-show-maps-in-a-webpage/-->

<!-- TODO: -->
<!-- Reclick on a marker, need to change behaviour...  -->
<!-- Add download data as xyz button -->
<!-- Always show stream segment and its strahler? -->
<!-- Polygons: Show strahler order as colour! -->
<!-- Add login, more subcatchments?? -->

<!DOCTYPE html>
<html>

<head>
  <title>Connectivity Tool</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Get the leaflet CSS file -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
integrity=
"sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin="" />
  <link rel="stylesheet" href="mystyle.css"/ >
  <!--script type="text/javascript" src="functions_ogc_requests_sync.js"></script-->
  <script type="text/javascript" src="functions_ogc_requests_async.js"></script>
  <script type="text/javascript" src="functions_styling.js"></script>
  <script type="text/javascript" src="functions_example_buttons.js"></script>
  <script type="text/javascript" src="functions_events.js"></script>
  <script type="text/javascript" src="functions_buttonclick.js"></script>
</head>

<body>
<div id="container">
  <div id="header">
    <a href="https://aquainfra.eu"><img src="logo_aquainfra.svg" height="35px" /></a>
  </div>

  <div id="body">
  <!--h1>TEMPORARILY OFFLINE: Connectivity Tool</h1-->
  <h1>Connectivity Tool</h1>
  <h3>On-the-fly upstream catchments</h3>


  <!-- Selection -->
  <p><span>Click on the map to display:</span></p>
  <select id="processes">
    <optgroup label="upstream">
      <option data-pairs="one" value="get-upstream-bbox">Upstream bounding box</option>
      <option data-pairs="one" value="get-upstream-dissolved-cont">Upstream catchment (one large polygon)</option>
      <option data-pairs="one" value="get-upstream-subcatchments">Upstream catchment (individual polygons)</option>
      <option data-pairs="one" value="get-upstream-streamsegments" selected="selected">Upstream stream segments</option>
    </optgroup>
    <optgroup label="local">
      <option data-pairs="one" value="get-local-streamsegments">Local stream segment</option>
      <option data-pairs="one" value="get-local-streamsegments-subcatchments">Local stream segment and local subcatchment</option>
      <option data-pairs="one" value="get-snapped-points">Snapped point</option>
      <option data-pairs="one" value="get-snapped-point-plus">Snapped point, local stream segment and local subcatchment</option>
    </optgroup>
    <optgroup label="routing">
      <option data-pairs="one" value="get-shortest-path-to-outlet">Shortest path from point to sea</option>
      <option data-pairs="two" value="get-shortest-path-between-points">Shortest path from point to point</option>
    </optgroup>
  </select>
  <label><input type="checkbox" id="stylingStrahlerToggle" checked>Style depending on <strong>strahler</strong> order</label>
  <div>(please choose!)...</div>
  <p id="scrollToTop">
    <span class="greynote">Note: Computing may take some time, depending on catchment size!</span>
    <br />
    <span class="greynote">Note: In case you click to a headwater, no upstream catchment is provided, as no upstream exists...</span>
  </p>


  <!-- Map -->
  <div id="map"></div>
  <!-- Behaviour is defined programmatically further below -->
  <p><button id="clearMapButton">Clear the map!</button></p>

  <!-- Custom lonlat button -->
  <h3>Input your own coordinates...</h3>
  <table>
    <tr>
    <!-- If you want the grey examples to disappear on focus, set onfocus to this:   onfocus="if(this.value=='9.17'){ this.value='NIX'; this.style.color='#000';}"   -->
      <td>Longitude:</td>
      <td>
        <input type="text" id="customLon1" value="9.0409"
          onblur="if(this.value==''){ this.value='9.0409'; this.style.color='#BBB';}"
          onfocus="if(this.value==''){ this.value='9.0409'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td>e.g. <span class="code">9.0409</span></td>
      <td class="fortwo invisible">
        <input type="text" id="customLon2" value="8.99853"
          onblur="if(this.value==''){ this.value='8.99853'; this.style.color='#BBB';}"
          onfocus="if(this.value==''){ this.value='8.99853'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td class="fortwo invisible">e.g. <span class="code">9.17</span></td>
    </tr>
    <tr>
      <td>Latitude:</td>
      <td>
        <input type="text" id="customLat1" value="52.7769"
          onblur="if(this.value==''){ this.value='52.7769'; this.style.color='#BBB';}"
          onfocus="if(this.value==''){ this.value='52.7769'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td>e.g. <span class="code">52.95</span></td>
      <td class="fortwo invisible">
        <input type="text" id="customLat2" value="52.799"
          onblur="if(this.value==''){ this.value='52.799'; this.style.color='#BBB';}"
          onfocus="if(this.value==''){ this.value='52.799'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td class="fortwo invisible">e.g. <span class="code">52.95</span></td>
    </tr>
    <tr>
      <td>Lon lat:</td>
      <td>
        <input type="text" id="customLonLat1" value="9.0409, 52.7769"
          onblur="if(this.value==''){ this.value='9.0409, 52.7769'; this.style.color='#BBB';}"
          onfocus="if(this.value==''){ this.value='9.0409, 52.7769'; this.style.color='#000';} else {this.style.color='#000';}"
          onfocus="{ this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td>e.g. <span class="code">8.99853, 52.799</span></td>
      <td class="fortwo invisible">
        <input type="text" id="customLonLat2" value="8.99853, 52.799"
          onblur="if(this.value==''){ this.value='8.99853, 52.799'; this.style.color='#BBB';}"
          onfocus="if(this.value==''){ this.value='8.99853, 52.799'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td class="fortwo invisible">e.g. <span class="code">9.17, 52.95</span></td>
    </tr>
    <tr>
      <td>Subcatchment id:</td>
      <td>
        <input type="text" id="customSubc1" value=""
          onfocus="if(this.value==''){ this.value='507044912'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td>e.g. <span class="code">507044912</span></td>
      <td class="fortwo invisible">
        <input type="text" id="customSubc2" value=""
          onfocus="if(this.value==''){ this.value='506924326'; this.style.color='#000';} else {this.style.color='#000';}"
          style="color:#BBB;" />
      </td>
      <td class="fortwo invisible">e.g. <span class="code">506924326</span></td>
    </tr>
  </table>
  <!-- Behaviour is defined programmatically further below -->
  <p><button id="customLonlatButton">Use these values!</button> (The result will be displayed in the map above)</p>


  <!-- Example buttons -->
  <h3>...or use these examples:</h3>
  <p>(The result will be displayed in the map above):</p>
  <table>
    <tr>
      <td><button id="example1" thislon="not set" thislat="not set">not set</button></td>
      <td id="example1desc">(not set)</td>
    </tr>
    <tr>
      <td><button  id="example2" thislon="not set" thislat="not set">not set</button></td>
      <td id="example2desc">(not set)</td>
    </tr>
    <tr>
      <td><button  id="example3" thislon="not set" thislat="not set">not set</button></td>
      <td id="example3desc">(not set)</td>
    </tr>
    <tr>
      <td><button  id="example4" thislon="not set" thislat="not set">not set</button></td>
      <td id="example4desc">(not set)</td>
    </tr>
    <tr>
      <td><button  id="example5" thislon="not set" thislat="not set">not set</button></td>
      <td id="example5desc">(not set)</td>
    </tr>
  </table>


  <!-- Text field for response -->
  <h3>Response returned by server:</h3>
  <p id="responseField">Response returned by server:</p>
  <p><textarea id="displayGeoJSON" class="codeblock" rows="20", cols="120">(Result GeoJSON will be displayed here)</textarea></p>

  <!-- Text field for adding custom GeoJSON -->
  <h3>Enter GeoJSON:</h3>
  <textarea id="customGeoJsonArea" class="codeblock" rows="5" cols="120" placeholder='Paste valid GeoJSON here'></textarea>
  <button id="customGeoJsonButton">Display on map</button>

  <h3>Data sources</h3>
  <p>The data based on which the above functionalities are computed is the <strong>Hydrography90m dataset</strong> (see <a href="https://hydrography.org">hydrography.org</a>), especially the vector layers contained in the <strong>GeoFRESH database</strong> (see <a href="https://geofresh.org">geofresh.org</a>):
  </p>
  <p class="cite">
    Amatulli, G., Garcia Marquez, J.R., Sethi, T., Kiesel, J., Grigoropoulou, A., Üblacker, M., Shen, L., Domisch, S. (2022). Hydrography90m: A new high-resolution global hydrographic dataset. Earth System Science Data, 14, 4525–4550.<br/><a href="https://doi.org/10.5194/essd-14-4525-2022">doi:10.5194/essd-14-4525-2022</a>.
  </p>
  <p class="cite">
    Domisch, S., Bremerich, V., Buurman, M., Kaminke, B., Tomiczek, T., Torres-Cambas, Y., Grigoropoulou, A., Garcia Marquez, J. R., Amatulli, G., Grossart, H. P., Gessner, M. O., Mehner, T., Adrian, R. & De Meester, L. (2024). GeoFRESH – an online platform for freshwater geospatial data processing. International Journal of Digital Earth, 17(1).<br/><a href="https://doi.org/10.1080/17538947.2024.2391033">doi:10.1080/17538947.2024.2391033</a>.
  </p>

  </div> <!-- end of body -->
  <div id="footer">
    <a href="https://www.igb-berlin.de/"><img src="logo_igb.svg" height="35px" /></a>
    <span id="contact"><a id="contact" href="https://glowabio.org/about/">Contact (GLOWABIO working group)</a></span>
  </div>
</div> <!-- end of container -->




  <!-- Get the leaflet JavaScript file -->
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity=
"sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>
  <script>

    // Initialize the map
    const map = L.map('map')

    // Collect layers so I can remove them:
    var allMyLayers = [];
    var allMyIcons = [];

    // Get the tile layer from OpenStreetMaps
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, // maximum zoom of map
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Set the view of the map
    // with the latitude, longitude and the zoom value
    // map.setView([60.19123, 24.94612], 10); // Helsinki
    map.setView([53.014, 12.008], 7); // Northern Germany

    // Other way. WORKS!
    //L.geoJSON(data, {
    //    style: function(feature) {
    //        switch (feature.properties.UnitID) {
    //            case 1: return {color: "#ff0000"};
    //            case 2: return {color: "#0000ff"};
    //      default: return {color: "#ff8c00"};
    //        }
    //    }
    //}).addTo(map);



    ///////////////////////////////
    //// Other Event Listeners ////
    ///////////////////////////////

    // Define event listener for adding custom GeoJSON
    // First, define a container for GeoJSON layer
    var geoJsonLayer;
    // Now, define the behaviour:
    var eventCustomGeojsonDisplay = function(evt) {
      try {
        let input = document.getElementById('customGeoJsonArea').value;
        let geojson = JSON.parse(input);

        // Remove existing layer if present
        if (geoJsonLayer) {
          map.removeLayer(geoJsonLayer);
        }

        // Add new GeoJSON layer, zoom to bounds
        geoJsonLayer = L.geoJSON(geojson).addTo(map);

        // Zoom to bounds of new layer, scroll up to map:
        map.fitBounds(geoJsonLayer.getBounds());
        //document.getElementById("map").scrollIntoView();
        document.getElementById("scrollToTop").scrollIntoView();
        // TODO: Can we add up, instead of removing previous? Then, add a delete button?

      } catch (err) {
        alert("Invalid GeoJSON:\n" + err.message);
      }
    };

    // Define event listener for change of process id, so I can switch off/ switch on
    // the buttons for examples (which only work for one-click examples)!
    var eventProcessChanged = function(evt){
      console.log("Process changed to: "+this.value);

      // Is this a process that needs one or two coordinate pairs?
      let pairs = evt.target.options[evt.target.selectedIndex].dataset.pairs;
      console.log("Process needs "+pairs+" coordinate pairs.");
      if (pairs == 'two') {
        defineTwoClickExampleButtons();
        var divsToHide = document.getElementsByClassName("fortwo");
        for(var i = 0; i < divsToHide.length; i++){
          divsToHide[i].classList.remove('invisible');
        }
      } else {
        defineOneClickExampleButtons();
        var divsToHide = document.getElementsByClassName("fortwo");
        for(var i = 0; i < divsToHide.length; i++){
          divsToHide[i].classList.add('invisible');
        }
      }

      // Previously, we had to disable the example buttons once a two-pair process
      // was selected, as we had no two-pair examples - now we do.
      //
      // But in case we include processes where we need to disable again:
      //if (pairs == 'n') {
      //  // now, n clicks are needed and our examples don't work anymore:
      //  let exampleButtons = document.getElementsByClassName("oneclickexample");
      //  for (let i = 0; i < exampleButtons.length; i++) {
      //    exampleButtons[i].disabled = true;
      //  }
      //} else {
      // now, 1-2 clicks are needed and our examples will work:
      //  let exampleButtons = document.getElementsByClassName("oneclickexample");
      //  for (let i = 0; i < exampleButtons.length; i++) {
      //    exampleButtons[i].disabled = false;
      //  }
      //}
    }





    ///////////////////////////////
    //// Other functions ////
    ///////////////////////////////

    // Function to add a grey marker, and a pop-up, to a location on the map
    var putIconToClickLocation = function(lon1, lat1, map, actionDone, askToClickAgain) {
      console.log("User "+actionDone+" (coordinates: "+lon1+", "+lat1+" (lon, lat, WGS84)");
      var iconheight = 30;
      var iconwidth = 0.61*iconheight;

      if (lon1 === null) {
        // Using map center to place the popup, but we don't use the map center as
        // processing input coordinates!
        var latlon = map.getCenter();
        console.log('Using map centre for placing popup: '+latlon)
        // This string will be displayed until function _ogcRequest() updates the text:
        var paramstring = "[no coordinates to display]";
        var iconUrl = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='; // 1x1 transparent gif
        var iconSize = [1, 1]; // minimal size
      } else {
        var lon1 = parseFloat(lon1);
        var lat1 = parseFloat(lat1);
        var latlon = [lat1, lon1];
        var paramstring = lon1.toFixed(3)+", "+lat1.toFixed(3)+" (lon, lat)...";
        var iconSize = [iconwidth, iconheight];
        var iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
      }

      // Icon for user-clicks
      var clickIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
        iconSize: iconSize,
        iconAnchor: [iconwidth*0.5, iconheight], // from top left corner: go half-width to right, full-height to bottom 
        popupAnchor: [0, -iconheight-5] // where iconAnchor is, go full-height to top plus 5 pixels
      });
      let clickMarker = L.marker(latlon, {icon: clickIcon}).addTo(map);
      allMyIcons.push(clickMarker);

      // Add Popup to user-click
      var dropdown = document.getElementById("processes");
      let processId = dropdown.value;
      var processDesc = dropdown.options[dropdown.selectedIndex].text
      if (askToClickAgain) {
        clickMarker.bindPopup("You selected "+processDesc+", so please click another time!").openPopup();
      } else {
        // Not a good place for defining this text, because here we only know the stuff relevant for
        // placing the popup (we don't know the subc_id etc.)...
        clickMarker.bindPopup("Waiting for "+processDesc+" for "+paramstring).openPopup();
        // This popup will be redefined/overwritten in ogcRequestTwoCoordinatePairs(), so put the same text!
      }
      console.log("When clicked, this process was selected: "+processId+"...");
      return (clickMarker);
    }

    // Global variables needed for behaviour on map click:
    var thisIsSecondClick = false;
    var firstClickLon = null;
    var firstClickLat = null;

    // Define behaviour on map click (function)
    var mapClickBehaviour = function(evt) {

      // Get coordinates from click location:
      clicklon = evt.latlng.lng;
      clicklat = evt.latlng.lat;
      console.log('There was a click: '+clicklon+', '+clicklat+' (lon, lat, WGS84)');

      // Which process?
      var dropdown = document.getElementById("processes");
      var processId = dropdown.value;
      var processDesc = dropdown.options[dropdown.selectedIndex].text;
      console.log('When clicked, this process was selected: '+processId+' ('+processDesc+').');
      // Check if we need two points!
      let pairs = dropdown.options[dropdown.selectedIndex].dataset.pairs;
      if (pairs == "two") {
        console.log('[DEBUG] Any function requiring two pairs of coordinates...');

        if (thisIsSecondClick) {
          // Second click of two!
          // Make sure the next click is counted the first:
          thisIsSecondClick = false;

          // Add icon and popup to click location:
          clickMarker = putIconToClickLocation(clicklon, clicklat, map, "clicked on map", false);

          // Construct and send HTTP request to OGC service:
          ogcRequestTwoCoordinatePairs(clickMarker, firstClickLon, firstClickLat, clicklon, clicklat);

        } else {
          // First click of two!
          // Make sure the next click is counted the second:
          thisIsSecondClick = true;

          // Add icon and popup to click location, telling user to click again
          clickMarker = putIconToClickLocation(clicklon, clicklat, map, "clicked on map", true);

          // Remember the coordinates of this first click, for the second:
          firstClickLat = clicklat;
          firstClickLon = clicklon;
        }

      // Normal process that works with one click!
      } else {
        console.log('[DEBUG] Any function requiring just one pair of coordinates...');

        // Add icon and popup to click location:
        clickMarker = putIconToClickLocation(clicklon, clicklat, map, "clicked on map", false);

        // Construct and send HTTP request to OGC service:
        ogcRequestOneCoordinatePair(clickMarker, clicklon, clicklat);
      }
    };

    // Define clearing the map
    var clearMap = function() {
      for (var i = 0; i < allMyLayers.length; i++) {
        map.removeLayer(allMyLayers[i]);
      };
      for (var i = 0; i < allMyIcons.length; i++) {
        map.removeLayer(allMyIcons[i]);
      };
      document.getElementById("displayGeoJSON").innerHTML = "";
    }


    //////////////////////////////////////////
    //// Define buttons and add behaviour ////
    //////////////////////////////////////////

    // Run the button content/text definition:
    defineOneClickExampleButtons();

    // Bind custom-button behaviour to the custom-button click event:
    document.getElementById("clearMapButton").onclick = clearMap;

    // Bind custom-button behaviour to the custom-button click event:
    document.getElementById("customLonlatButton").onclick = customButtonClickBehaviour;

    // Bind one-click or two-click to the event of process change:
    document.getElementById("processes").addEventListener('input', eventProcessChanged);

    // When a user modifies text fields "lon", "lat" or "lon,lat", modify the others accordinly:
    document.getElementById("customLonLat1").addEventListener('input', eventLonLat1Changed);
    document.getElementById("customLon1").addEventListener('input', eventLon1Changed);
    document.getElementById("customLat1").addEventListener('input', eventLatChanged);
    document.getElementById("customLonLat2").addEventListener('input', eventLonLat2Changed);
    document.getElementById("customLon2").addEventListener('input', eventLon2Changed);
    document.getElementById("customLat2").addEventListener('input', eventLat2Changed);
    // When a user modifies/focuses the subcatchment id field, remove the coordinates:
    document.getElementById("customSubc1").addEventListener('input', eventSubcid1Changed);
    document.getElementById("customSubc1").addEventListener('focus', eventSubcid1Changed);
    document.getElementById("customSubc2").addEventListener('input', eventSubcid2Changed);
    document.getElementById("customSubc2").addEventListener('focus', eventSubcid2Changed);
    // When a user focuses back on coordinates, remove the subcatchment fields:
    document.getElementById("customLonLat1").addEventListener('focus', eventCoord1Focus);
    document.getElementById("customLon1").addEventListener('focus', eventCoord1Focus);
    document.getElementById("customLat1").addEventListener('focus', eventCoord1Focus);
    document.getElementById("customLonLat2").addEventListener('focus', eventCoord2Focus);
    document.getElementById("customLon2").addEventListener('focus', eventCoord2Focus);
    document.getElementById("customLat2").addEventListener('focus', eventCoord2Focus);

    // When a user clicks the button to display custom GeoJSON
    document.getElementById('customGeoJsonButton').addEventListener('click', eventCustomGeojsonDisplay);

    // Bind map click behaviour to the map click event:
    console.log('Waiting for user to click to get a coordinate...');
    map.on('click', mapClickBehaviour);


  </script>
</body>

</html>


